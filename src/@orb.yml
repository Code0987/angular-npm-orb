version: 2.1

description: >
  Test, build and publish Angular libraries to npm.

executors:
  node:
    docker:
      - image: circleci/node
  browsers:
    docker:
      - image: circleci/node:browsers

jobs:
  test:
    parameters:
      project:
        type: string

    executor: browsers
    steps:
      - checkout
      - run:
          name: 🛠️ Installing npm dependencies
          command: if [ ! -d "node_modules" ]; then npm ci; fi
      - run:
          name: 🛠️ Restoring package-lock.json
          command: git checkout package-lock.json
      - run:
          name: 🛠️ Upgrading Chrome
          command: |
            wget -q -O - https://dl.google.com/linux/linux_signing_key.pub | sudo apt-key add -
            sudo sh -c 'echo "deb [arch=amd64] http://dl.google.com/linux/chrome/deb/ stable main" >> /etc/apt/sources.list.d/google.list'
            sudo apt-get update
            sudo apt-get install google-chrome-stable
      - run:
          name: 🛠️ Building
          command: npm run build -- << parameters.project >>
      - run:
          name: ✅ Running unit tests
          command: npm run test -- << parameters.project >> --watch false --progress false
      - run:
          name: ✅ Running e2e tests
          command: npm run e2e -- << parameters.project >>
      - store_test_results:
          path: test-results

  build:
    parameters:
      project:
        type: string

    executor: node
    steps:
      - checkout
      - run:
          name: 🛠️ Installing npm dependencies
          command: if [ ! -d "node_modules" ]; then npm ci; fi
      - run:
          name: 🛠️ Restoring package-lock.json
          command: git checkout package-lock.json
      - run:
          name: 🛠️ Building
          command: npm run build -- << parameters.project >>
      - persist_to_workspace:
          root: .
          paths:
            - dist

  publish:
    parameters:
      path:
        type: string
      access:
        type: string
        default: public

    executor: node
    steps:
      - attach_workspace:
          at: .
      - run:
          name: 🛠️ Initializing npm-cli-adduser
          command: sudo npm install -g npm-cli-adduser && npm-cli-adduser
      - run:
          name: 📦 Publishing npm package
          command: cd << parameters.path >> && npm publish --access=<< parameters.access >>
